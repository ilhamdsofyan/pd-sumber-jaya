# ----------------------------------------------------------------------
# Core WordPress Security Rules
# ----------------------------------------------------------------------

# Disable Directory Browsing
Options -Indexes

# Block Access to wp-config.php and other sensitive files (readme, license)
<FilesMatch "^(wp-config\.php|_?error_log|readme\.html|license\.txt)$">
    Require all denied
</FilesMatch>

# Block Access to Hidden Files/Directories (.git, .env, .htaccess)
<FilesMatch "^\.">
    Require all denied
</FilesMatch>
# Except for .well-known (often used for Let's Encrypt SSL validation)
<FilesMatch "^\.well-known">
    Require all granted
</FilesMatch>

# Block Access to XML-RPC (if you exclusively use REST API and not Jetpack/Mobile app)
<Files xmlrpc.php>
    Require all denied
</Files>

# ----------------------------------------------------------------------
# WordPress Core Rewrite Rules
# ----------------------------------------------------------------------
# BEGIN WordPress
# The directives (lines) between "BEGIN WordPress" and "END WordPress" are
# dynamically generated, and should only be modified via WordPress filters.
# Any changes to the directives between these markers will be overwritten.
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]
RewriteBase /wordpress/
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /wordpress/index.php [L]
</IfModule>

# END WordPress

# ----------------------------------------------------------------------
# Security Headers & Content Security Policy (Google Analytics/GTM/Ads Ready)
# ----------------------------------------------------------------------
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Enable XSS protection filter in older browsers
    Header always set X-XSS-Protection "1; mode=block"
    
    # Prevent Clickjacking (blocks embedding your site in frames/iframes on other sites)
    Header always set X-Frame-Options "SAMEORIGIN"
    
    # Control how much referrer information sent to external sites
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Implement Strict Transport Security (HSTS) if using HTTPS (One Year caching)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains" env=HTTPS
    
    # Content Security Policy setup mapped for Google properties
    # Note: 'unsafe-inline' and 'unsafe-eval' are kept for standard WP themes/plugins compatibility.
    # We expand script/img/connect/frame sources for: GA, GTM, Google Ads properties
    Header always set Content-Security-Policy "\
        default-src 'self' 'unsafe-inline' 'unsafe-eval' https: data:; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' \
            https://www.google-analytics.com \
            https://ssl.google-analytics.com \
            https://www.googletagmanager.com \
            https://www.googleadservices.com \
            https://googleads.g.doubleclick.net \
            https://tpc.googlesyndication.com; \
        img-src 'self' data: \
            https://www.google-analytics.com \
            https://ssl.google-analytics.com \
            https://www.google.com \
            https://googleads.g.doubleclick.net \
            https://stats.g.doubleclick.net \
            https://secure.gravatar.com \
            https://lh3.googleusercontent.com \
            http://*.gravatar.com; \
        connect-src 'self' \
            https://www.google-analytics.com \
            https://stats.g.doubleclick.net \
            https://region1.google-analytics.com; \
        frame-src 'self' \
            https://www.googletagmanager.com \
            https://bid.g.doubleclick.net; \
        "
</IfModule>